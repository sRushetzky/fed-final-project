<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic page metadata -->
    <meta charset="UTF-8" />
    <title>Cost Manager - idb.js Test</title>
</head>

<body>
<!-- Load the vanilla idb.js which exposes window.idb -->
<script src="idb.js"></script>

<script>
    // Run a basic end-to-end test for:
    // openCostsDB -> setRatesUrl -> addCost -> getReport (multiple currencies)
    async function test() {
        try {
            // Open (or create) the IndexedDB database
            const db = await idb.openCostsDB("costsdb", 1);
            console.log("creating db succeeded");

            // 1) Set exchange rates URL (must be accessible + CORS enabled)
            //(It works even without set rates URL, by fetching the default rates.json)
            const ratesUrl = "https://fed-final-project-up72.onrender.com/rates.json";
            await db.setRatesUrl(ratesUrl);
            console.log("setRatesUrl succeeded:", ratesUrl);

            // 2) Add multiple costs (mix currencies + categories)
            const items = [
                { sum: 200, currency: "USD", category: "FOOD", description: "pizza" },
                { sum: 120, currency: "GBP", category: "EDUCATION", description: "Zoom License" },
                { sum: 50, currency: "EURO", category: "FOOD", description: "sandwich" },
                { sum: 180, currency: "ILS", category: "CAR", description: "fuel" },
                { sum: 25, currency: "USD", category: "HEALTH", description: "vitamins" }
            ];

            // Insert items (addCost saves today's date in the record)
            for (let i = 0; i < items.length; i++) {
                const res = await db.addCost(items[i]);
                console.log(`adding cost #${i + 1} succeeded`, res);
            }

            // 3) Get report for current year/month (because addCost stores today's date)
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1..12

            // Get the same report in different currencies
            const reportUSD = await db.getReport(year, month, "USD");
            const reportILS = await db.getReport(year, month, "ILS");
            const reportEURO = await db.getReport(year, month, "EURO");
            const reportGBP = await db.getReport(year, month, "GBP");

            // Print reports to console (for manual verification)
            console.log("REPORT (USD):", reportUSD);
            console.log("REPORT (ILS):", reportILS);
            console.log("REPORT (EURO):", reportEURO);
            console.log("REPORT (GBP):", reportGBP);
        } catch (err) {
            // If anything fails, show the error clearly
            console.error("TEST FAILED:", err);
        }
    }

    // Start the test immediately
    test();
</script>
</body>
</html>
